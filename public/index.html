<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불안 퇴치 서비스</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; min-height: 20px; }
        .tag { background: #e9ecef; padding: 5px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 5px; border: 1px solid #dee2e6; }
        .tag b { cursor: pointer; color: #ff4d4f; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background: #0056b3; }
        .add-btn { width: 80px; background: #6c757d; margin: 10px 0 10px 5px; }
        .card { background: #f1f3f5; padding: 15px; border-radius: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="onboarding-section">
            <h2>불안 퇴치 서비스에 온 것을 환영해요!</h2>
            
            <label>ID</label>
            <input type="text" id="participantId" placeholder="ID를 입력하세요">

            <label>불안 요소 (여러 개 입력 가능)</label>
            <div style="display: flex;">
                <input type="text" id="anxietyInput" placeholder="예: 직장, 관계, 미래, 건강" style="flex: 1;">
                <button type="button" class="add-btn" onclick="addAnxietyTag()">추가</button>
            </div>
            <div id="anxietyTagsContainer" class="tag-container"></div>

            <label>현재 불안 수치: <span id="levelDisplay">5</span></label>
            <input type="range" id="initialAnxiety" min="1" max="10" value="5">

            <label>사용 목적</label>
            <select id="purpose">
                <option value="care">감정 정리</option>
                <option value="positive">미래를 긍정적으로 상상하기</option>
                <option value="pattern">불안 패턴을 알고 싶어요</option>
            </select>

            <button id="submitBtn" onclick="submitOnboarding()">시작하기</button>
            <p id="onboardingStatus" style="text-align: center; color: #007bff;"></p>
        </div>

        <div id="dashboard-section" class="hidden">
            <h2 id="welcomeMsg">환영합니다!</h2>
            <div class="card">
                <p><strong>등록된 불안 요소:</strong></p>
                <div id="summaryFactors" class="tag-container"></div>
                <p><strong>오늘의 불안 지수:</strong> <span id="summaryLevel"></span></p>
            </div>
            <button onclick="location.reload()" style="background:#6c757d;">다시 설정하기</button>
        </div>
    </div>

    <script>
        let anxietyList = [];

        // 태그 추가 로직
        function addAnxietyTag() {
            const input = document.getElementById('anxietyInput');
            const val = input.value.trim();
            if (val && !anxietyList.includes(val)) {
                anxietyList.push(val);
                renderTags();
                input.value = "";
            }
        }

        function renderTags() {
            const container = document.getElementById('anxietyTagsContainer');
            container.innerHTML = anxietyList.map((tag, i) => `
                <div class="tag">${tag} <b onclick="removeTag(${i})">×</b></div>
            `).join('');
        }

        function removeTag(i) {
            anxietyList.splice(i, 1);
            renderTags();
        }

        // 수치 표시
        document.getElementById('initialAnxiety').addEventListener('input', (e) => {
            document.getElementById('levelDisplay').innerText = e.target.value;
        });

        // 엔터키 지원
        document.getElementById('anxietyInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addAnxietyTag();
        });

        // [핵심] 데이터 전송 및 화면 전환
        async function submitOnboarding() {
            const pId = document.getElementById('participantId').value;
            const level = document.getElementById('initialAnxiety').value;
            const purpose = document.getElementById('purpose').value;

            if (!pId) { alert("ID를 입력해주세요!"); return; }
            if (anxietyList.length === 0) { alert("불안 요소를 최소 하나 추가해주세요!"); return; }

            const status = document.getElementById('onboardingStatus');
            status.innerText = "데이터 저장 중...";

            try {
                const response = await fetch('/api/onboarding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        participantId: pId,
                        anxietyFactors: anxietyList,
                        initialAnxiety: level,
                        purpose: purpose
                    })
                });

                if (response.ok) {
                    // 성공 시 화면 전환
                    document.getElementById('onboarding-section').classList.add('hidden');
                    document.getElementById('dashboard-section').classList.remove('hidden');
                    
                    document.getElementById('welcomeMsg').innerText = `안녕하세요, ${pId}님!`;
                    document.getElementById('summaryLevel').innerText = level;
                    document.getElementById('summaryFactors').innerHTML = anxietyList.map(t => `<span class="tag">${t}</span>`).join('');
                } else {
                    status.innerText = "저장 실패 (서버 오류)";
                }
            } catch (err) {
                status.innerText = "연결 오류가 발생했습니다.";
            }
        }
    </script>
</body>
</html>

