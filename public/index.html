<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불안 퇴치 서비스</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .card { background: #f1f3f5; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 5px solid #007bff; }
        h2 { color: #333; }
        label { font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="onboarding-section">
            <h2>불안 퇴치 서비스</h2>
            <label>ID</label>
            <input type="text" id="participantId" placeholder="예: User_01">

            <label>요즘 나를 불안하게 하는 것들 (여러 개 추가 가능)</label>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="anxietyInput" placeholder="예: 직장, 관계, 미래, 건강 (엔터 또는 추가 클릭)">
                <button type="button" onclick="addAnxietyTag()" style="width: 80px; background: #6c757d;">추가</button>
            </div>
            <div id="anxietyTagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 30px;"></div>

            <label>현재 불안 수치: <span id="levelDisplay">5</span></label>
            <input type="range" id="initialAnxiety" min="1" max="10" value="5">

            <label>사용 목적</label>
            <select id="purpose">
                <option value="care">감정 정리</option>
                <option value="tracking">미래를 긍정적으로 상상하기</option>
                <option value="video">불안 패턴을 알고 싶어요</option>
            </select>

            <button onclick="submitOnboarding()">시작하기</button>
            <p id="onboardingStatus"></p>
        </div>

        <div id="dashboard-section" class="hidden">
            <h2 id="welcomeMsg">반가워요!</h2>
            <div class="card">
                <p><strong>내 현재 상태</strong></p>
                <p id="statusSummary">데이터를 불러오는 중...</p>
            </div>
            
            <hr>
            <h3>영상 생성 히스토리</h3>
            <div id="historyList">
                <p>생성된 영상이 아직 없습니다.</p>
            </div>
            <button onclick="location.reload()" style="background:#6c757d; margin-top:20px;">다시 온보딩하기</button>
        </div>
    </div>

    <script>

        // 불안 요소들을 담을 배열
        let anxietyList = [];
        
        // 태그 추가 함수
        function addAnxietyTag() {
            const input = document.getElementById('anxietyInput');
            const value = input.value.trim();
            
            if (value && !anxietyList.includes(value)) {
                anxietyList.push(value);
                renderTags();
                input.value = "";
            }
        }
        
        // 엔터 키로도 추가 가능하게 설정
        document.getElementById('anxietyInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addAnxietyTag();
            }
        });
        
        // 화면에 태그 그리기
        function renderTags() {
            const container = document.getElementById('anxietyTagsContainer');
            container.innerHTML = anxietyList.map((tag, index) => `
                <span style="background: #e9ecef; padding: 5px 10px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                    ${tag} 
                    <b onclick="removeTag(${index})" style="cursor:pointer; color:red;">×</b>
                </span>
            `).join('');
        }
        
        // 태그 삭제 기능
        function removeTag(index) {
            anxietyList.splice(index, 1);
            renderTags();
        }
        
        // [수정된] 데이터 전송 함수
        async function submitOnboarding() {
            const data = {
                participantId: document.getElementById('participantId').value,
                anxietyFactors: anxietyList, // 이제 배열로 전송됩니다!
                initialAnxiety: document.getElementById('initialAnxiety').value,
                purpose: document.getElementById('purpose').value
            };
        
            if (!data.participantId || anxietyList.length === 0) {
                alert("ID와 불안 요소를 최소 하나 이상 입력해주세요!");
                return;
            }
            
            // ... 기존 fetch 코드와 동일 (단, 데이터 전송 시 anxietyFactors 전송)
            const response = await fetch('/api/onboarding', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                showDashboard(data);
            }
        }
                
        // 슬라이더 수치 실시간 업데이트
        document.getElementById('initialAnxiety').addEventListener('input', (e) => {
            document.getElementById('levelDisplay').innerText = e.target.value;
        });

        // [POST] 온보딩 데이터 저장
        async function submitOnboarding() {
            const data = {
                participantId: document.getElementById('participantId').value,
                anxietyFactor: document.getElementById('anxietyFactor').value,
                initialAnxiety: document.getElementById('initialAnxiety').value,
                purpose: document.getElementById('purpose').value
            };

            if (!data.participantId) {
                alert("ID를 입력해주세요!");
                return;
            }

            const status = document.getElementById('onboardingStatus');
            status.innerText = "저장 중...";

            try {
                const response = await fetch('/api/onboarding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showDashboard(data);
                } else {
                    status.innerText = "서버 오류가 발생했습니다.";
                }
            } catch (err) {
                console.error(err);
                status.innerText = "연결 실패.";
            }
        }

        // 화면 전환: 온보딩 -> 대시보드
        function showDashboard(userData) {
            document.getElementById('onboarding-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            
            document.getElementById('welcomeMsg').innerText = `안녕하세요, ${userData.participantId}님!`;
            document.getElementById('statusSummary').innerText = 
                `불안 요소: ${userData.anxietyFactor}\n초기 수치: ${userData.initialAnxiety}`;
            
            loadHistory(); // 기존 영상 히스토리 불러오기
        }

        // [GET] 영상 히스토리 불러오기
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            try {
                const response = await fetch('/api/history');
                const data = await response.json();

                if (data.length > 0) {
                    historyList.innerHTML = data.map(item => `
                        <div class="card">
                            <small>Prompt:</small>
                            <p style="margin:5px 0 0 0;">${item.prompt}</p>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.log("히스토리 로드 실패");
            }
        }
    </script>
</body>
</html>



