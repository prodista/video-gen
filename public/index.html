<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Anxiety Eliminator</title>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f0f2f5;
        }
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #ccc; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
        }
        .container { 
            width: 100%; 
            max-width: 430px; 
            min-height: 100vh; 
            background: white; 
            padding: 25px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2); 
            box-sizing: border-box;
            position: relative;
        }
        .hidden { display: none !important; }
        
        /* í™ˆ ë§í¬ ìŠ¤íƒ€ì¼ */
        .home-link {
            cursor: pointer;
            font-weight: bold;
            color: #888;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 8px;
            transition: background 0.2s;
            display: inline-block;
            margin-bottom: 10px;
        }
        .home-link:hover { background: #f0f0f0; color: var(--primary-color); }

        input, textarea, select { 
            width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; font-size: 16px;
        }
        button { 
            width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; transition: opacity 0.2s;
        }
        button:active { opacity: 0.7; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
        .tag { background: #eef2ff; color: #444; padding: 6px 14px; border-radius: 20px; font-size: 14px; border: 1px solid #dbeafe; }
        .card { background: #f8faff; padding: 20px; border-radius: 16px; margin-top: 15px; border: 1px solid #eef2ff; }
        
        .input-group { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
        .input-group input { flex: 1; margin: 0; }
        .add-btn { width: auto !important; padding: 12px 18px !important; margin: 0 !important; background: #6c757d; font-size: 14px; }

        .thumb-placeholder {
            min-width: 100px; height: 75px; background: #e9ecef; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #adb5bd; font-size: 12px; flex-shrink: 0; border: 1px solid #dee2e6;
        }

        .survey-option.selected {
            border: 2px solid var(--primary-color) !important;
            background-color: #eef2ff !important;
            color: var(--primary-color) !important;
            font-weight: bold;
        }

        .bot-msg, .user-msg {
            max-width: 85%;
            padding: 12px 16px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-all;
        }
        
        .bot-msg {
            background: #eef2ff;
            color: #333;
            border-radius: 18px 18px 18px 0;
            align-self: flex-start;
        }
        
        .user-msg {
            background: var(--primary-color);
            color: white;
            border-radius: 18px 18px 0 18px;
            align-self: flex-end;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="home-link" onclick="goHome()">ğŸ  Anxiety Eliminator</div>

        <div id="intro-section">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: var(--primary-color); font-size: 28px; margin-bottom: 10px;">Anxiety Eliminator</h1>
                <p style="color: #666; font-size: 15px; line-height: 1.5;">
                    ë³¸ í”Œë«í¼ì€ ìƒì„±í˜• AIê°€ ë§¤ê°œí•œ ì˜ìƒ ì„œì‚¬ê°€<br>
                    íƒ€ì¸ì— ëŒ€í•œ ì´í•´ì™€ ê³µê°ì„ ì–´ë–»ê²Œ ì´‰ì§„í•˜ëŠ”ì§€ ì—°êµ¬í•©ë‹ˆë‹¤.
                </p>
            </div>
        
            <div class="card" style="border: 2px solid #eef2ff;">
                <h3 style="margin-top: 0; color: #28a745;">Study 1. ìì „ì  ì„œì‚¬ ì‹œê°í™”</h3>
                <p style="font-size: 14px; color: #555;">ìì‹ ì˜ ê°€ì¹˜ê´€ê³¼ ì‚¶ì˜ ê²½í—˜ì„ AIì™€ í˜‘ì—…í•˜ì—¬ ì˜ìƒìœ¼ë¡œ ì œì‘í•˜ê³ , í‘œí˜„ì˜ ì ì ˆì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.</p>
                <button onclick="startStudy1()" style="background:#28a745;">ë‚´ ì˜ìƒ ì œì‘ ì‹œì‘í•˜ê¸°</button>
            </div>
        
            <div class="card" style="border: 2px solid #f8faff;">
                <h3 style="margin-top: 0; color: var(--primary-color);">Study 2. íƒ€ì¸ ì´í•´ íš¨ê³¼ ê²€ì¦</h3>
                <p style="font-size: 14px; color: #555;">AIë¡œ ìƒì„±ëœ íƒ€ì¸ì˜ ì˜ìƒ ì„œì‚¬ë¥¼ ì‹œì²­í•˜ê³ , í•´ë‹¹ ì¸ë¬¼ì— ëŒ€í•œ ê³µê°ê³¼ ì´í•´ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤.</p>
                <button onclick="startStudy2()" style="background: var(--primary-color);">íƒ€ì¸ ì˜ìƒ í‰ê°€ ì‹œì‘í•˜ê¸°</button>
            </div>
        
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <p style="font-size: 14px; color: #888;">ê¸°ì¡´ ì°¸ê°€ìì´ì‹ ê°€ìš”?</p>
                <input type="text" id="loginId" placeholder="ì°¸ê°€ì ID ì…ë ¥">
                <button onclick="loginUser()" style="background: #6c757d; padding: 12px;">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>

        <div id="survey-section" class="hidden">
            <div id="survey-intro">
                <h2>ì²˜ìŒì´ì‹œêµ°ìš”!</h2>
                <p style="color: #666; line-height: 1.6;">
                    ë°˜ê°‘ìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•˜ê¸° ì „ì—,<br>
                    ë‹¹ì‹ ì— ëŒ€í•´ ì¡°ê¸ˆ ë” ì•Œê³  ì‹¶ì–´ìš”.<br>
                    ì ì‹œ ì„¤ë¬¸ì¡°ì‚¬ì— ì‘í•´ì£¼ì‹œê² ì–´ìš”?
                </p>
                <button onclick="startActualQuestions()" style="background:#28a745; margin-top: 20px;">ë„¤, ì¢‹ì•„ìš”!</button>
            </div>
        
            <div id="survey-container" class="hidden">
                <div id="survey-content"></div>
                <div class="input-group" style="margin-top: 30px;">
                    <button id="prevBtn" style="background: #6c757d; flex: 1;">ì´ì „</button>
                    <button id="nextBtn" style="background: #007bff; flex: 1;">ë‹¤ìŒ</button>
                </div>
            </div>
        </div>
        
         <div id="study2-section" class="hidden">
            <div style="display: flex; align-items: center; margin-bottom: 20px; gap: 10px;">
                <button onclick="goHome()" style="width: auto; padding: 8px 12px; background: #f0f0f0; color: #333; margin: 0;">â†</button>
                <h2 style="margin: 0;">íƒ€ì¸ ì´í•´ë„ í‰ê°€</h2>
            </div>
        
            <div class="card" style="background: #fff; border: 1px solid #ddd;">
                <p style="font-size: 13px; color: #666; margin-bottom: 10px;">ë‹¤ìŒì€ ë‹¤ë¥¸ ì°¸ê°€ìì˜ ìì „ì  ì„œì‚¬ì…ë‹ˆë‹¤.</p>
                
                <div id="stimulus-content">
                    <div id="video-stimulus" style="width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
                        <p>ğŸ¥ AI Generated Video Player</p>
                    </div>
                    <div id="text-stimulus" style="margin-top: 15px; line-height: 1.6; color: #333;">
                        "ì €ëŠ” ì–´ë¦´ ì ë¶€í„° ê²½ìŸì ì¸ í™˜ê²½ì—ì„œ ìëìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì‘ë…„ì— ìˆ²ìœ¼ë¡œ ì—¬í–‰ì„ ê°€ì„œ ì²˜ìŒìœ¼ë¡œ ê³ ìš”í•¨ì„ ëŠê¼ˆê³ , ê·¸ë•Œë¶€í„° 'ë‚´ë©´ì˜ í‰í™”'ê°€ ì œ ì‚¶ì˜ ê°€ì¥ ì¤‘ìš”í•œ ê°€ì¹˜ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤..."
                    </div>
                </div>
            </div>
        
            <div style="margin-top: 25px;">
                <p style="font-weight: bold;">Q1. ì´ ì‚¬ëŒì˜ ê°€ì¹˜ê´€ì´ ì–¼ë§ˆë‚˜ ëª…í™•í•˜ê²Œ ì´í•´ë˜ë‚˜ìš”?</p>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <label><input type="radio" name="empathy1" value="1"> 1</label>
                    <label><input type="radio" name="empathy1" value="2"> 2</label>
                    <label><input type="radio" name="empathy1" value="3"> 3</label>
                    <label><input type="radio" name="empathy1" value="4"> 4</label>
                    <label><input type="radio" name="empathy1" value="5"> 5</label>
                </div>
        
                <p style="font-weight: bold;">Q2. ì´ ì‚¬ëŒì˜ ê²½í—˜ì— ëŒ€í•´ ì–¼ë§ˆë‚˜ ê³µê°ì´ ê°€ë‚˜ìš”?</p>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <label><input type="radio" name="empathy2" value="1"> 1</label>
                    <label><input type="radio" name="empathy2" value="2"> 2</label>
                    <label><input type="radio" name="empathy2" value="3"> 3</label>
                    <label><input type="radio" name="empathy2" value="4"> 4</label>
                    <label><input type="radio" name="empathy2" value="5"> 5</label>
                </div>
        
                <label style="font-weight: bold;">Q3. ì´ ì˜ìƒ(í˜¹ì€ ê¸€)ì„ ë³´ê³  ëŠë‚€ ê°ì •ì„ ì ì–´ì£¼ì„¸ìš”.</label>
                <textarea id="qualitative-resp" placeholder="ììœ ë¡­ê²Œ ê¸°ìˆ í•´ì£¼ì„¸ìš”." style="height: 100px;"></textarea>
        
                <button onclick="submitEvaluation()" style="background: var(--primary-color); margin-top: 20px;">í‰ê°€ ì™„ë£Œ</button>
            </div>
        </div> 
        
        <div id="onboarding-section" class="hidden">
            <h2>ê±°ì˜ ë‹¤ ëì–´ìš”!</h2>
            <label>ID ì„¤ì •</label>
            <input type="text" id="participantId" placeholder="ì‚¬ìš©í•˜ì‹¤ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">

            <label>ë¶ˆì•ˆ ìš”ì†Œ (ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”)</label>
            <div class="input-group">
                <input type="text" id="anxietyInput" placeholder="ì˜ˆ: ì§ì¥, ê±´ê°•, ë¯¸ë˜">
                <button type="button" class="add-btn" onclick="addAnxietyTag()">ì¶”ê°€</button>
            </div>
            <div id="anxietyTagsContainer" class="tag-container"></div>

            <label>í˜„ì¬ ë¶ˆì•ˆ ìˆ˜ì¹˜: <span id="levelDisplay">5</span></label>
            <input type="range" id="initialAnxiety" min="1" max="10" value="5">

            <label>ì‚¬ìš© ëª©ì </label>
            <select id="purpose">
                <option value="care">ê°ì • ì •ë¦¬</option>
                <option value="positive">ë¯¸ë˜ë¥¼ ê¸ì •ì ìœ¼ë¡œ ìƒìƒí•˜ê¸°</option>
                <option value="pattern">ë¶ˆì•ˆ íŒ¨í„´ íŒŒì•…</option>
            </select>

            <button onclick="submitOnboarding()">ì‹œì‘í•˜ê¸°</button>
        </div>

        <div id="dashboard-section" class="hidden">
            <h2 id="welcomeMsg">ì•ˆë…•í•˜ì„¸ìš”!</h2>
            <div class="card">
                <p>ğŸ“Š í‰ê·  ë¶ˆì•ˆ ìˆ˜ì¹˜: <span id="avgAnxiety" style="font-weight:bold; color:red;">-</span></p>
                <p>ğŸ· ì£¼ìš” í‚¤ì›Œë“œ: <span id="topKeyword" style="font-weight:bold; color:blue;">-</span></p>
            </div>
            <div style="margin-top: 20px;">
                <p style="font-weight: bold;">ğŸ¥ ìµœê·¼ ì˜ìƒ</p>
                <div id="recentVideos" style="display: flex; gap: 10px; overflow-x: auto;">
                    <div class="thumb-placeholder">ê¸°ë¡ ì—†ìŒ</div>
                </div>
            </div>
            <div style="margin-top: 25px;">
                <button onclick="toggleTracking()" style="background:#28a745;">ğŸ“Š ë‚˜ì˜ ë³€í™” í™•ì¸í•˜ê¸° (íŠ¸ë˜í‚¹)</button>
                <button onclick="startConversation()" style="background:#ff7b00; margin-top:12px;">ğŸ’¬ ì˜¤ëŠ˜ì˜ ëŒ€í™” ì‹œì‘í•˜ê¸°</button>
            </div>
            <div id="tracking-section" class="hidden" style="margin-top:20px;">
                <canvas id="anxietyChart"></canvas>
            </div>
        </div>

        <div id="chat-section" class="hidden">
            <div style="display: flex; align-items: center; margin-bottom: 20px; gap: 10px;">
                <button onclick="showSection('dashboard-section')" style="width: auto; padding: 8px 12px; background: #f0f0f0; color: #333; margin: 0;">â†</button>
                <h2 style="margin: 0;">ë§ˆìŒ ë‚˜ëˆ„ê¸°</h2>
            </div>
        
            <div id="chat-window" style="height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 16px; padding: 15px; background: #fafafa; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;">
                <div class="bot-msg" style="background: #eef2ff; padding: 10px 15px; border-radius: 15px 15px 15px 0; align-self: flex-start; max-width: 85%; font-size: 14px;">
                    ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ ì–´ë–¤ ë§ˆìŒì´ ë‹¹ì‹ ì„ í˜ë“¤ê²Œ í•˜ë‚˜ìš”? ë‹¹ì‹ ì˜ ë¶ˆì•ˆì„ í•¨ê»˜ ë“¤ì—¬ë‹¤ë³´ê³ , Veoë¡œ íŠ¹ë³„í•œ ìœ„ë¡œ ì˜ìƒì„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.
                </div>
            </div>
        
            <div class="input-group">
                <input type="text" id="chatInput" placeholder="ë‹¹ì‹ ì˜ ë§ˆìŒì„ ì ì–´ì£¼ì„¸ìš”..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="add-btn" style="background: var(--primary-color);">ì „ì†¡</button>
            </div>
        
            <div id="video-gen-area" class="hidden" style="margin-top: 20px; text-align: center;">
                <p style="font-size: 13px; color: #666;">ëŒ€í™”ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìœ„ë¡œ ì˜ìƒì„ ë§Œë“¤ ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <button onclick="generateVideo()" style="background: #ff7b00;">âœ¨ Veoë¡œ íë§ ì˜ìƒ ìƒì„±í•˜ê¸°</button>
            </div>
        </div>
            
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let anxietyList = [];
        let myChart = null;

        const surveyQuestions = [
            { question: "ìš”ì¦˜ ì ì€ ì˜ ì£¼ë¬´ì‹œë‚˜ìš”?", options: ["ë§¤ìš° ì˜ ì ", "ë³´í†µ", "ìì£¼ ê¹¨ê±°ë‚˜ ëª» ì "] },
            { question: "í•˜ë£¨ ì¤‘ ê°€ì¥ ë¶ˆì•ˆí•œ ì‹œê°„ëŒ€ëŠ”?", options: ["ì•„ì¹¨", "ì˜¤í›„", "ë°¤/ìê¸° ì „"] },
            { question: "ë¶ˆì•ˆí•  ë•Œ ë‚˜íƒ€ë‚˜ëŠ” ì¦ìƒì€?", options: ["ë‘ê·¼ê±°ë¦¼", "í˜¸í¡ ê³¤ë€", "ê·¼ìœ¡ ê¸´ì¥", "ì—†ìŒ"] }
        ];

        function showSection(sectionId, isBack = false) {
            const sections = [
                'intro-section',
                'survey-section',
                'onboarding-section',
                'dashboard-section',
                'chat-section',
                'study2-section'];
            
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        
            const target = document.getElementById(sectionId);
            if (target) target.classList.remove('hidden');
            
            if (!isBack) {
                history.pushState({ sectionId: sectionId }, '', `#${sectionId}`);
            }
        }

        function goHome() {
            if (confirm("ì²˜ìŒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                currentQuestionIndex = 0;
                userAnswers = [];
                showSection('intro-section');
            }
        }

        window.onpopstate = (e) => showSection(e.state?.sectionId || 'intro-section', true);

        // --- ì„¤ë¬¸ ë¡œì§ ---
        function goToSurveyIntro() {
            showSection('survey-section');
            document.getElementById('survey-intro').classList.remove('hidden');
            document.getElementById('survey-container').classList.add('hidden');
        }

        function startActualQuestions() {
            document.getElementById('survey-intro').classList.add('hidden');
            document.getElementById('survey-container').classList.remove('hidden');
            renderSurvey();
        }

        function renderSurvey() {
            const content = document.getElementById('survey-content');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const data = surveyQuestions[currentQuestionIndex];

            content.innerHTML = `
                <h3>Q${currentQuestionIndex + 1}.</h3>
                <p style="font-weight:bold;">${data.question}</p>
                ${data.options.map(opt => `
                    <button class="survey-option ${userAnswers[currentQuestionIndex] === opt ? 'selected' : ''}" 
                            onclick="selectOption('${opt}')" style="background:white; color:#333; border:1px solid #ddd; text-align:left;">
                        ${opt}
                    </button>
                `).join('')}
            `;

            // ì´ì „ ë²„íŠ¼: ì²« ì§ˆë¬¸ì´ë©´ goHomeìœ¼ë¡œ ì—°ê²°
            prevBtn.innerText = currentQuestionIndex === 0 ? "ì²˜ìŒìœ¼ë¡œ" : "ì´ì „";
            prevBtn.onclick = currentQuestionIndex === 0 ? goHome : prevSurvey;
            
            nextBtn.disabled = !userAnswers[currentQuestionIndex];
            nextBtn.innerText = currentQuestionIndex === surveyQuestions.length - 1 ? "ì™„ë£Œ" : "ë‹¤ìŒ";
            nextBtn.onclick = nextSurvey;
        }

        function selectOption(opt) {
            userAnswers[currentQuestionIndex] = opt;
            renderSurvey();
        }

        function nextSurvey() {
            if (currentQuestionIndex < surveyQuestions.length - 1) {
                currentQuestionIndex++;
                renderSurvey();
            } else {
                showSection('onboarding-section');
            }
        }

        function prevSurvey() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderSurvey();
            }
        }

        // --- ì˜¨ë³´ë”© ë° ê¸°íƒ€ ---
        function addAnxietyTag() {
            const input = document.getElementById('anxietyInput');
            if (input.value.trim() && !anxietyList.includes(input.value)) {
                anxietyList.push(input.value.trim());
                renderTags();
                input.value = "";
            }
        }

        function renderTags() {
            document.getElementById('anxietyTagsContainer').innerHTML = anxietyList.map((t, i) => `
                <div class="tag">${t} <b onclick="anxietyList.splice(${i},1);renderTags();" style="cursor:pointer">Ã—</b></div>
            `).join('');
        }

        document.getElementById('initialAnxiety').oninput = (e) => document.getElementById('levelDisplay').innerText = e.target.value;

        async function submitOnboarding() {
        
            try {
                const response = await fetch('/api/user/onboarding', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                
                if (response.status === 404) {
                    console.error("404 ì—ëŸ¬ ë°œìƒ: ì„œë²„ ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.");
                }
                // ...
            } catch (err) {
                console.error(err);
            }
        }
        
        const express = require('express');
        const mongoose = require('mongoose');
        const app = express();
        
        app.use(express.json()); // JSON ë°ì´í„°ë¥¼ ì½ê¸° ìœ„í•œ ì„¤ì •
        
        // MongoDB ì—°ê²° (ë³¸ì¸ì˜ URIë¡œ êµì²´)
        mongoose.connect('mongodb+srv://ID:PW@cluster.mongodb.net/myDatabase');
        
        const userSchema = new mongoose.Schema({
            participantId: String,
            anxietyFactors: [String],
            initialAnxiety: Number,
            videoUrl: String,  // ìƒì„±ëœ ì˜ìƒ ê²½ë¡œ ì €ì¥ìš©
            createdAt: { type: Date, default: Date.now }
        });
        
        const User = mongoose.model('User', userSchema);
        
        // ì˜¨ë³´ë”© ë°ì´í„° ì €ì¥ API
        app.post('/api/user/onboarding', async (req, res) => {
            try {
                const newUser = new User(req.body);
                await newUser.save();
                res.status(200).send({ message: "ì €ì¥ ì„±ê³µ!" });
            } catch (err) {
                res.status(500).send(err);
            }
        });
        
        async function loginUser() {
            const pId = document.getElementById('loginId').value.trim();
            if (!pId) { 
                alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); 
                return; 
            }
        
            try {
                const response = await fetch(`/api/user/${pId}`);
                
                if (response.ok) {
                    // [ì„±ê³µ] ê¸°ë¡ì´ ìˆëŠ” ê²½ìš°
                    const userData = await response.json();
                    anxietyList = userData.anxietyFactors || [];
                    const initialLevel = userData.initialAnxiety || "5";
        
                    document.getElementById('welcomeMsg').innerText = `ì•ˆë…•í•˜ì„¸ìš”, ${userData.participantId}ë‹˜!`;
                    document.getElementById('avgAnxiety').innerText = initialLevel;
                    document.getElementById('topKeyword').innerText = anxietyList.map(tag => `#${tag}`).join(' ');
        
                    showSection('dashboard-section');
                } else {
                    // [ì‹¤íŒ¨] ì„œë²„ëŠ” ì‘ë‹µí–ˆìœ¼ë‚˜ í•´ë‹¹ IDê°€ ì—†ëŠ” ê²½ìš° (404 ë“±)
                    if (confirm("ë“±ë¡ë˜ì§€ ì•Šì€ IDì…ë‹ˆë‹¤.\nì´ IDë¡œ ìƒˆë¡œ ë§Œë“œì‹œê² ì–´ìš”?")) {
                        goToOnboardingWithId(pId);
                    }
                }
            } catch (err) {
                // [ì—ëŸ¬] ì„œë²„ ìì²´ê°€ êº¼ì ¸ìˆê±°ë‚˜ ì—°ê²°í•  ìˆ˜ ì—†ëŠ” ê²½ìš°
                console.error("Connection Error:", err);
                if (confirm("í˜„ì¬ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ê±°ë‚˜ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nìƒˆë¡œìš´ ì•„ì´ë””ë¡œ ì‹œì‘í•˜ì‹œê² ì–´ìš”?")) {
                    goToOnboardingWithId(pId);
                }
            }
        }
        
        // ì•„ì´ë””ë¥¼ ë“¤ê³  ì˜¨ë³´ë”© í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™ì‹œì¼œì£¼ëŠ” ë³´ì¡° í•¨ìˆ˜
        function goToOnboardingWithId(pId) {
            showSection('onboarding-section');
            document.getElementById('participantId').value = pId; // ë¡œê·¸ì¸í•˜ë ¤ë˜ IDë¥¼ ìë™ìœ¼ë¡œ ì±„ì›Œì¤Œ
        }
        
        function toggleTracking() {
            const el = document.getElementById('tracking-section');
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('anxietyChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1ì›”', '2ì›”', '3ì›”', 'í˜„ì¬'],
                    datasets: [{ label: 'ë¶ˆì•ˆ ì§€ìˆ˜', data: [7, 5, 8, document.getElementById('initialAnxiety').value], borderColor: '#007bff' }]
                }
            });
        }

        // 1. ëŒ€í™” ì‹œì‘ í•¨ìˆ˜
        function startConversation() {
            console.log("ëŒ€í™” ì‹œì‘!"); // ë””ë²„ê¹…ìš©
            showSection('chat-section');
            
            // ì±„íŒ…ì°½ ì§„ì… ì‹œ ì´ˆê¸° ë©”ì‹œì§€ ì„¸íŒ… (ì„ íƒ ì‚¬í•­)
            const chatWindow = document.getElementById('chat-window');
            if (chatWindow.children.length <= 1) { // ë©”ì‹œì§€ê°€ ì´ˆê¸° ë©”ì‹œì§€ í•˜ë‚˜ë¿ì´ë¼ë©´
                // ì¶”ê°€ ë¡œì§ í•„ìš” ì‹œ ì—¬ê¸°ì— ì‘ì„±
            }
        }
        
        // 2. ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const chatWindow = document.getElementById('chat-window');
            const text = input.value.trim();
        
            if (!text) return;
        
            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            appendMessage('user', text);
            input.value = "";
        
            // ëŒ€í™” ì¤‘ì—ëŠ” ì˜ìƒ ìƒì„± ë²„íŠ¼ ë³´ì´ê¸° (ì˜ˆì‹œ: ì²« ë©”ì‹œì§€ ì´í›„ ë°”ë¡œ ë…¸ì¶œ)
            document.getElementById('video-gen-area').classList.remove('hidden');
        
            // [ì—¬ê¸°ì— ChatGPT API ì—°ë™]
            // ì§€ê¸ˆì€ ë°ëª¨ìš© ìë™ ì‘ë‹µ
            setTimeout(() => {
                appendMessage('bot', `ë‹¹ì‹ ì´ ëŠë¼ëŠ” '${text}'ì— ëŒ€í•œ ë¶ˆì•ˆì„ ì´í•´í•´ìš”. ê·¸ ìƒí™©ì„ ì•„ë¦„ë‹¤ìš´ ì˜ìƒìœ¼ë¡œ ë°”ê¾¸ì–´ ì‹œê°í™”í•´ ë“œë¦´ê²Œìš”.`);
            }, 800);
        }
        
        function appendMessage(sender, text) {
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            
            if (sender === 'user') {
                msgDiv.style = "background: var(--primary-color); color: white; padding: 10px 15px; border-radius: 15px 15px 0 15px; align-self: flex-end; max-width: 85%; font-size: 14px;";
            } else {
                msgDiv.style = "background: #eef2ff; color: #333; padding: 10px 15px; border-radius: 15px 15px 15px 0; align-self: flex-start; max-width: 85%; font-size: 14px;";
            }
            
            msgDiv.innerText = text;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // ìŠ¤í¬ë¡¤ í•˜ë‹¨ ê³ ì •
        }
        
        // 3. Veo/Sora ì˜ìƒ ìƒì„± í•¨ìˆ˜
        async function generateVideo() {
            const pId = document.getElementById('participantId').value;
            alert("ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤...");
        
            // ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ AI API(Luma ë“±)ë¥¼ í˜¸ì¶œí•˜ê³  URLì„ ë°›ì•„ì˜´
            const fakeVideoUrl = "https://example.com/generated-video.mp4"; 
        
            // ìƒì„±ëœ URLì„ MongoDBì— ì €ì¥í•˜ê¸° ìœ„í•´ ë°±ì—”ë“œ í˜¸ì¶œ
            await fetch('/api/user/update-video', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    participantId: pId,
                    videoUrl: fakeVideoUrl
                })
            });
        
            alert("ì˜ìƒ ì €ì¥ ì™„ë£Œ!");
            showSection('dashboard-section');
        }
        
        // Study 1 ì‹œì‘ (ê¸°ì¡´ì˜ ì„¤ë¬¸ -> ì˜¨ë³´ë”© -> ì±„íŒ… íë¦„)
        function startStudy1() {
            console.log("Study 1 ì‹œì‘: ì œì‘ì ëª¨ë“œ");
            // ì´ˆê¸°í™”ê°€ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— ì‘ì„±
            currentQuestionIndex = 0;
            userAnswers = [];
            goToSurveyIntro(); // ê¸°ì¡´ ì„¤ë¬¸ í˜ì´ì§€ë¡œ ì´ë™
        }
        
        // Study 2 ì‹œì‘ (íƒ€ì¸ ì˜ìƒ í‰ê°€ ëª¨ë“œ)
        function startStudy2() {
            // 1. ì‹¤í—˜êµ°/ëŒ€ì¡°êµ° ë¬´ì‘ìœ„ í• ë‹¹ (A: í…ìŠ¤íŠ¸, B: ì‚¬ì§„, C: ì˜ìƒ)
            const conditions = ['A', 'B', 'C'];
            const assignedCondition = conditions[Math.floor(Math.random() * conditions.length)];
            
            console.log(`í”¼í—˜ì í• ë‹¹ ì¡°ê±´: ${assignedCondition}`);
            
            // 2. ì„¹ì…˜ ì „í™˜
            showSection('study2-section');
            
            // 3. ì¡°ê±´ë³„ UI ì œì–´
            const videoEl = document.getElementById('video-stimulus');
            if (assignedCondition === 'A') {
                videoEl.style.display = 'none'; // í…ìŠ¤íŠ¸ë§Œ ë³´ì—¬ì¤Œ
            } else {
                videoEl.style.display = 'flex'; // ì˜ìƒ/ì‚¬ì§„ ì˜ì—­ ë³´ì—¬ì¤Œ
            }
        }
        
        async function submitEvaluation() {
            // ì„¤ë¬¸ ì‘ë‹µ ìˆ˜ì§‘
            const q1 = document.querySelector('input[name="empathy1"]:checked')?.value;
            const q2 = document.querySelector('input[name="empathy2"]:checked')?.value;
            const textResp = document.getElementById('qualitative-resp').value;
        
            if (!q1 || !q2) {
                alert("ëª¨ë“  í‰ê°€ ë¬¸í•­ì— ë‹µí•´ì£¼ì„¸ìš”.");
                return;
            }
        
            // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ (ì‹¤ì œ API ì—°ê²° ì‹œ)
            console.log("í‰ê°€ ë°ì´í„°:", { q1, q2, textResp });
        
            alert("í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!");
            goHome();
        }
        
    </script>
</body>
</html>




