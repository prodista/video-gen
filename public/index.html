<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>ë¶ˆì•ˆ í‡´ì¹˜ ì„œë¹„ìŠ¤</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; min-height: 20px; }
        .tag { background: #e9ecef; padding: 5px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 5px; border: 1px solid #dee2e6; }
        .tag b { cursor: pointer; color: #ff4d4f; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background: #0056b3; }
        .add-btn { width: 80px; background: #6c757d; margin: 10px 0 10px 5px; }
        .card { background: #f1f3f5; padding: 15px; border-radius: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="intro-section">
            <h2>ë°˜ê°€ì›Œìš”!</h2>
            <p>ë¶ˆì•ˆ í‡´ì¹˜ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>
            <button onclick="showSection('onboarding-section')" style="background:#28a745;">ì²˜ìŒ ì™”ì–´ìš” (ì‹ ê·œ ìœ ì €)</button>
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <p>ì´ë¯¸ ì´ìš©í•œ ì ì´ ìˆë‚˜ìš”?</p>
                <input type="text" id="loginId" placeholder="ê¸°ì¡´ ID ì…ë ¥">
                <button onclick="loginUser()">ë‚´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>
    
        <div id="onboarding-section" class="hidden">
            <button id="submitBtn" onclick="submitOnboarding()">ì‹œì‘í•˜ê¸°</button>
        </div>
    
        <div id="dashboard-section" class="hidden">
            </div>
    </div>

        <div id="onboarding-section">
            <h2>ë¶ˆì•ˆ í‡´ì¹˜ ì„œë¹„ìŠ¤ì— ì˜¨ ê²ƒì„ í™˜ì˜í•´ìš”!</h2>
            
            <label>ID</label>
            <input type="text" id="participantId" placeholder="IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">

            <label>ë¶ˆì•ˆ ìš”ì†Œ (ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥)</label>
            <div style="display: flex;">
                <input type="text" id="anxietyInput" placeholder="ì˜ˆ: ì§ì¥, ê´€ê³„, ë¯¸ë˜, ê±´ê°•" style="flex: 1;">
                <button type="button" class="add-btn" onclick="addAnxietyTag()">ì¶”ê°€</button>
            </div>
            <div id="anxietyTagsContainer" class="tag-container"></div>

            <label>í˜„ì¬ ë¶ˆì•ˆ ìˆ˜ì¹˜: <span id="levelDisplay">5</span></label>
            <input type="range" id="initialAnxiety" min="1" max="10" value="5">

            <label>ì‚¬ìš© ëª©ì </label>
            <select id="purpose">
                <option value="care">ê°ì • ì •ë¦¬</option>
                <option value="positive">ë¯¸ë˜ë¥¼ ê¸ì •ì ìœ¼ë¡œ ìƒìƒí•˜ê¸°</option>
                <option value="pattern">ë¶ˆì•ˆ íŒ¨í„´ì„ ì•Œê³  ì‹¶ì–´ìš”</option>
            </select>

            <button id="submitBtn" onclick="submitOnboarding()">ì‹œì‘í•˜ê¸°</button>
            <p id="onboardingStatus" style="text-align: center; color: #007bff;"></p>
        </div>

        <div id="dashboard-section" class="hidden">
            <h2 id="welcomeMsg">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <div class="card">
                <p><strong>ë“±ë¡ëœ ë¶ˆì•ˆ ìš”ì†Œ:</strong></p>
                <div id="summaryFactors" class="tag-container"></div>
                <p><strong>ì˜¤ëŠ˜ì˜ ë¶ˆì•ˆ ì§€ìˆ˜:</strong> <span id="summaryLevel"></span></p>
            </div>
        
            <button onclick="toggleTracking()" style="background:#28a745; margin-top:10px;">ğŸ“Š ë‚˜ì˜ ë³€í™” í™•ì¸í•˜ê¸° (íŠ¸ë˜í‚¹)</button>
        
            <div id="tracking-section" class="hidden" style="margin-top:20px;">
                <h3>ë¶ˆì•ˆ ìˆ˜ì¹˜ ë³€í™”</h3>
                <canvas id="anxietyChart" width="400" height="200"></canvas>
            </div>
        
            <button onclick="location.reload()" style="background:#6c757d; margin-top:10px;">ë‹¤ì‹œ ì„¤ì •í•˜ê¸°</button>
        </div>
    </div>

    <script>

        // ì„¹ì…˜ ì „í™˜ ê³µí†µ í•¨ìˆ˜
        function showSection(sectionId) {
            document.getElementById('intro-section').classList.add('hidden');
            document.getElementById('onboarding-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            
            document.getElementById(sectionId).classList.remove('hidden');
        }
        
        // ê¸°ì¡´ ìœ ì € ë¡œê·¸ì¸ í•¨ìˆ˜
        async function loginUser() {
            const pId = document.getElementById('loginId').value;
            if (!pId) { alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
        
            try {
                const response = await fetch(`/api/user/${pId}`);
                if (response.ok) {
                    const userData = await response.json();
                    // ê¸°ì¡´ì— ì €ì¥ëœ ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ì„¸íŒ…
                    anxietyList = userData.anxietyFactors || [];
                    document.getElementById('initialAnxiety').value = userData.initialAnxiety;
                    
                    showDashboard(userData); 
                } else {
                    alert("ë“±ë¡ë˜ì§€ ì•Šì€ IDì…ë‹ˆë‹¤. ì‹ ê·œ ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
                }
            } catch (err) {
                console.error(err);
                alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // showDashboard í•¨ìˆ˜ ìˆ˜ì • (ê¸°ì¡´ ë°ì´í„°ì™€ UI ë™ê¸°í™”)
        function showDashboard(userData) {
            showSection('dashboard-section');
            document.getElementById('welcomeMsg').innerText = `ë‹¤ì‹œ ì˜¤ì…¨êµ°ìš”, ${userData.participantId}ë‹˜!`;
            document.getElementById('summaryLevel').innerText = userData.initialAnxiety;
            document.getElementById('summaryFactors').innerHTML = 
                (userData.anxietyFactors || []).map(t => `<span class="tag">${t}</span>`).join('');
        }
        
        let anxietyList = [];

        // íƒœê·¸ ì¶”ê°€ ë¡œì§
        function addAnxietyTag() {
            const input = document.getElementById('anxietyInput');
            const val = input.value.trim();
            if (val && !anxietyList.includes(val)) {
                anxietyList.push(val);
                renderTags();
                input.value = "";
            }
        }

        function renderTags() {
            const container = document.getElementById('anxietyTagsContainer');
            container.innerHTML = anxietyList.map((tag, i) => `
                <div class="tag">${tag} <b onclick="removeTag(${i})">Ã—</b></div>
            `).join('');
        }

        function removeTag(i) {
            anxietyList.splice(i, 1);
            renderTags();
        }

        // ìˆ˜ì¹˜ í‘œì‹œ
        document.getElementById('initialAnxiety').addEventListener('input', (e) => {
            document.getElementById('levelDisplay').innerText = e.target.value;
        });

        // ì—”í„°í‚¤ ì§€ì›
        document.getElementById('anxietyInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addAnxietyTag();
        });

        // [í•µì‹¬] ë°ì´í„° ì „ì†¡ ë° í™”ë©´ ì „í™˜
        async function submitOnboarding() {
            const pId = document.getElementById('participantId').value;
            const level = document.getElementById('initialAnxiety').value;
            const purpose = document.getElementById('purpose').value;

            if (!pId) { alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
            if (anxietyList.length === 0) { alert("ë¶ˆì•ˆ ìš”ì†Œë¥¼ ìµœì†Œ í•˜ë‚˜ ì¶”ê°€í•´ì£¼ì„¸ìš”!"); return; }

            const status = document.getElementById('onboardingStatus');
            status.innerText = "ë°ì´í„° ì €ì¥ ì¤‘...";

            try {
                const response = await fetch('/api/onboarding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        participantId: pId,
                        anxietyFactors: anxietyList,
                        initialAnxiety: level,
                        purpose: purpose
                    })
                });

                if (response.ok) {
                    // ì„±ê³µ ì‹œ í™”ë©´ ì „í™˜
                    document.getElementById('onboarding-section').classList.add('hidden');
                    document.getElementById('dashboard-section').classList.remove('hidden');
                    
                    document.getElementById('welcomeMsg').innerText = `ì•ˆë…•í•˜ì„¸ìš”, ${pId}ë‹˜!`;
                    document.getElementById('summaryLevel').innerText = level;
                    document.getElementById('summaryFactors').innerHTML = anxietyList.map(t => `<span class="tag">${t}</span>`).join('');
                } else {
                    status.innerText = "ì €ì¥ ì‹¤íŒ¨ (ì„œë²„ ì˜¤ë¥˜)";
                }
            } catch (err) {
                status.innerText = "ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        let myChart = null; // ì°¨íŠ¸ ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        
        function toggleTracking() {
            const trackingSection = document.getElementById('tracking-section');
            trackingSection.classList.toggle('hidden');
        
            if (!trackingSection.classList.contains('hidden')) {
                renderChart();
            }
        }
        
        function renderChart() {
            const ctx = document.getElementById('anxietyChart').getContext('2d');
            
            // ì´ë¯¸ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ íŒŒê´´í•˜ê³  ìƒˆë¡œ ê·¸ë¦¼ (ì¤‘ë³µ ìƒì„± ë°©ì§€)
            if (myChart) {
                myChart.destroy();
            }
        
            // ìƒ˜í”Œ ë°ì´í„° (ì§€ê¸ˆì€ ì´ˆê¸° ìˆ˜ì¹˜ í•˜ë‚˜ë§Œ ìˆì§€ë§Œ, ë‚˜ì¤‘ì—” DBì—ì„œ ì—¬ëŸ¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤)
            const initialLevel = document.getElementById('initialAnxiety').value;
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', 'í˜„ì¬'], // ì˜ˆì‹œ ë¼ë²¨
                    datasets: [{
                        label: 'ë¶ˆì•ˆ ì§€ìˆ˜',
                        data: [7, 6, 8, 5, initialLevel], // ì•ì— 4ê°œëŠ” ì˜ˆì‹œ, ë§ˆì§€ë§‰ì´ í˜„ì¬ ì…ë ¥ê°’
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }
        
    </script>
</body>
</html>





